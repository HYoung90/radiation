<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ì‚¬ì„  ë¹„ìƒ ëŒ€ì‘ ì˜ì‚¬ê²°ì • ì§€ì› ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* ê¸°ë³¸ PC ë° íƒœë¸”ë¦¿ ìŠ¤íƒ€ì¼ */
        body {
            background-color: #f3f4f6;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: row;
            min-height: 100vh;
            padding-right: 20px;
            margin-left: 250px; /* ì‚¬ì´ë“œë°” ê¸¸ì´ë§Œí¼ ì™¼ìª½ ì—¬ë°± ì¶”ê°€ */
        }

        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            flex-grow: 1;
        }

        .sidebar {
            width: 250px;
            background-color: #343a40;
            padding-top: 20px;
            color: white;
            font-size: 18px;
            text-align: center;
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.1);
            z-index: 1001; /* ì±—ë´‡ë³´ë‹¤ ìœ„ì— ìœ„ì¹˜ */
        }

        .sidebar img {
            width: 200px;
            margin-bottom: 30px;
            cursor: pointer;
        }

        .sidebar a {
            color: white;
            padding: 15px;
            text-decoration: none;
            display: block;
            transition: 0.3s;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .sidebar a:hover {
            background-color: #575757;
            transform: translateX(5px);
        }

        .container {
            margin-top: 20px;
            flex-grow: 1;
            padding-left: 20px;
            margin-right: 20px;
            width: 100%;
        }

        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #f5f5f5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .header-logo img {
            height: 180px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .header-logo img:hover {
            transform: scale(1.05);
        }

        .title-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .title-container h1 {
            font-size: 36px;
            margin: 0;
            color: #000000;
            text-align: center;
            width: 100%;
        }

        .refresh-icon {
            font-size: 15px;
            color: #333;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .grid-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        .grid-item h5 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #333;
        }

        .grid-item p {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }

        .grid-item p strong {
            color: #333;
        }

        /* ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ - ëª¨ë°”ì¼ í™”ë©´ (í™”ë©´ ë„ˆë¹„ 768px ì´í•˜) */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ë³€ê²½ */
                margin-left: 0;         /* ì‚¬ì´ë“œë°” ì™¼ìª½ ì—¬ë°± ì œê±° */
                padding-right: 0;
            }

            .sidebar {
                width: 100%;            /* ì‚¬ì´ë“œë°” ë„ˆë¹„ë¥¼ 100%ë¡œ ë³€ê²½ */
                height: auto;           /* ë†’ì´ ìë™ ì¡°ì ˆ */
                position: relative;     /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ìƒëŒ€ ìœ„ì¹˜ë¡œ ë³€ê²½ */
                box-shadow: none;       /* ê·¸ë¦¼ì ì œê±° */
            }

            .sidebar img {
                width: 150px;           /* ì´ë¯¸ì§€ í¬ê¸° ì¶•ì†Œ */
                margin-top: 20px;       /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
            }

            .container {
                padding: 10px;          /* ì—¬ë°±ì„ 10pxë¡œ ì¤„ì´ê¸° */
                margin: 0;              /* ë§ˆì§„ ì œê±° */
            }

            .header-container {
                margin-bottom: 10px;    /* í•˜ë‹¨ ì—¬ë°± ì¶•ì†Œ */
            }

            .title-container h1 {
                font-size: 24px;        /* ì œëª© í¬ê¸° ì¶•ì†Œ */
            }

            .refresh-icon {
                font-size: 12px;        /* ì‹œê°„ í¬ê¸° ì¶•ì†Œ */
                margin-top: 5px;        /* ìƒë‹¨ ì—¬ë°± ì¶•ì†Œ */
                justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
            }

            #map {
                height: 300px;          /* ì§€ë„ì˜ ë†’ì´ ì¶•ì†Œ */
                margin-bottom: 20px;    /* í•˜ë‹¨ ì—¬ë°± ì¶•ì†Œ */
            }

            .grid-container {
                grid-template-columns: 1fr; /* ê·¸ë¦¬ë“œë¥¼ 1ì—´ë¡œ ë³€ê²½ */
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="ë°©ì‚¬ì„  ë°ì´í„°" onclick="location.reload()">
        <a href="/radiation_summary">ì£¼ê°„ ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„°</a>
        <a href="/nuclear_radiation">ì›ìë ¥ ë°œì „ì†Œ ì£¼ë³€ ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„°</a>
        <a href="/busan_radiation">ë¶€ì‚° í™˜ê²½ë°©ì‚¬ì„ ëŸ‰ ë°ì´í„°</a>
        <a href="{{ url_for('accident_select') }}">ì›ìë ¥ ë°œì „ì†Œ ì‚¬ê³  íŒë‹¨</a>
        <a href="{{ url_for('optimal_shelter_evaluation') }}">êµ¬í˜¸ì†Œ ëŒ€í”¼ ì í•©ë„ í‰ê°€</a>
        <a href="/spectrum">ë°©ì‚¬ì„± í•µì¢… ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„</a>
        <a href="/analysis1">í† ì–‘ ë°©ì‚¬ëŠ¥ ë°ì´í„°</a>
        <a href="/analysis2">ëŒ€ê¸° ì¤‘ ë°©ì‚¬ëŠ¥ ë°ì´í„°</a>
        <a href="/analysis4">ìˆ˜ì¤‘ ë°©ì‚¬ëŠ¥ ë°ì´í„°</a>
    </div>

    <div class="container mt-5">
        <div class="header-container">
            <div class="title-container">
                <h1 id="title">ë°©ì‚¬ì„  ë¹„ìƒ ëŒ€ì‘ ì˜ì‚¬ê²°ì • ì§€ì› ì‹œìŠ¤í…œ</h1>
            </div>
            <div class="refresh-icon">
                <span id="currentTime"></span>
            </div>
        </div>

        <div id="map"></div>

        <div class="weather-container">
            <h2 class="mb-4">ìµœê·¼ ê¸°ìƒ ë°ì´í„°</h2>
            <div class="grid-container" id="weatherGridContainer">
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        function updateCurrentTime() {
            var now = new Date();
            var formattedDateTime = now.toLocaleString();
            document.getElementById('currentTime').textContent = formattedDateTime;
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        var map = L.map('map').setView([36.5, 127.5], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> | &copy; OpenStreetMap contributors',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        var regions = {
            "KR": [35.3213, 129.2941, "ê³ ë¦¬ ì›ìë ¥ë°œì „ì†Œ"],
            "WS": [35.7131, 129.4775, "ì›”ì„± ì›ìë ¥ë°œì „ì†Œ"],
            "YK": [35.4165, 126.4178, "í•œë¹› ì›ìë ¥ë°œì „ì†Œ"],
            "UJ": [37.0941, 129.3819, "í•œìš¸ ì›ìë ¥ë°œì „ì†Œ"],
            "SU": [35.3376, 129.3115, "ìƒˆìš¸ ì›ìë ¥ë°œì „ì†Œ"],
        };

        for (var genName in regions) {
            var marker = L.marker([regions[genName][0], regions[genName][1]]).addTo(map)
                .bindPopup('<div class="custom-popup-title"><a href="/' + genName + '" style="text-decoration:none;color:black;">' + regions[genName][2] + '</a></div>');

            marker.on('click', function() {
                this.openPopup();
            });
        }

        function loadLatestWeatherData() {
            const weatherGridContainer = document.getElementById("weatherGridContainer");
            weatherGridContainer.innerHTML = "";
            const plantNames = {
                "KR": "ê³ ë¦¬ ì›ìë ¥ë°œì „ì†Œ",
                "WS": "ì›”ì„± ì›ìë ¥ë°œì „ì†Œ",
                "YK": "í•œë¹› ì›ìë ¥ë°œì „ì†Œ",
                "UJ": "í•œìš¸ ì›ìë ¥ë°œì „ì†Œ",
                "SU": "ìƒˆìš¸ ì›ìë ¥ë°œì „ì†Œ"
            };

            for (let genName in plantNames) {
                fetch(`/api/data/${genName}/latest`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Received latest data for genName ${genName}:`, data);
                        if (data.time) {
                            const gridItem = document.createElement("div");
                            gridItem.className = "grid-item";
                            gridItem.innerHTML = `
                                <h5>${plantNames[genName]}</h5>
                                <p><strong>ì¸¡ì • ì‹œê°„:</strong> ${data.time || 'ì •ë³´ ì—†ìŒ'}</p>
                                <p><strong>ê¸°ì˜¨:</strong> ${data.temperature || 'ì •ë³´ ì—†ìŒ'}Â°C</p>
                                <p><strong>ìŠµë„:</strong> ${data.humidity || 'ì •ë³´ ì—†ìŒ'}%</p>
                                <p><strong>ê°•ìˆ˜ëŸ‰:</strong> ${data.rainfall !== undefined && data.rainfall !== null ? data.rainfall : '0 '}mm</p>
                                <p><strong>í’ì†:</strong> ${data.windspeed !== undefined && data.windspeed !== null ? data.windspeed : '0 '}m/s</p>
                                <p><strong>í’í–¥:</strong> ${data.winddirection || 'ì •ë³´ ì—†ìŒ'}Â°</p>
                                <p><strong>ì•ˆì •ë„:</strong> ${data.stability || 'ì •ë³´ ì—†ìŒ'}</p>
                            `;
                            weatherGridContainer.appendChild(gridItem);
                        } else {
                            console.error(`Unexpected data format for genName ${genName}:`, data);
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching latest weather data for genName ${genName}:`, error);
                    });
            }
        }

        loadLatestWeatherData();
    </script>
    <div id="chat-icon" style="position: fixed; bottom: 24px; right: 24px; z-index: 1000; cursor: pointer;">
      <img src="{{ url_for('static', filename='images/chat_icon.png') }}" alt="Chat" width="60" height="60">
    </div>
    <div id="chat-box" style="display:none; position:fixed; bottom:100px; right:24px; width:300px; height:400px; background:white; border:1px solid #ccc; border-radius:10px; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.15); overflow:hidden; font-family: sans-serif;">
      <header style="background:#007bff; color:white; padding:10px; font-weight:bold;">ë¹„ìƒ ëŒ€ì‘ ì±—ë´‡</header>
      <div id="chat-messages" style="padding:10px; height:300px; overflow-y:auto; font-size:14px;"></div>
      <div style="display:flex; border-top:1px solid #ccc;">
        <input id="user-input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1; padding:8px; border:none;">
        <button onclick="sendMessage()" style="background:#007bff; color:white; border:none; padding:8px 12px;">ì „ì†¡</button>
      </div>
    </div>
    <script>
      const chatIcon = document.getElementById("chat-icon");
      const chatBox = document.getElementById("chat-box");
      const chatMessages = document.getElementById("chat-messages");
      chatIcon.onclick = () => {
        chatBox.style.display = (chatBox.style.display === "none") ? "block" : "none";
      };
      function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message) return;
        chatMessages.innerHTML += `<div><strong>ğŸ‘¤ ì‚¬ìš©ì:</strong> ${message}</div>`;
        input.value = "";
        fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        })
        .then(res => res.json())
        .then(data => {
          const answer = data.answer || "ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          chatMessages.innerHTML += `<div><strong>ğŸ¤– ì±—ë´‡:</strong> ${answer}</div>`;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(() => {
          chatMessages.innerHTML += `<div><strong>ğŸ¤– ì±—ë´‡:</strong> ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        });
      }
    </script>
     <script>
        const codeToDisplay={
          "KR":"ê³ ë¦¬ ì›ìë ¥ë°œì „ì†Œ",
          "WS":"ì›”ì„± ì›ìë ¥ë°œì „ì†Œ",
          "YK":"í•œë¹› ì›ìë ¥ë°œì „ì†Œ",
          "UJ":"í•œìš¸ ì›ìë ¥ë°œì „ì†Œ",
          "SU":"ìƒˆìš¸ ì›ìë ¥ë°œì „ì†Œ"
        };
        const codeToShort={
          "KR":"ê³ ë¦¬","WS":"ì›”ì„±","YK":"í•œë¹›","UJ":"í•œìš¸","SU":"ìƒˆìš¸"
        };
        async function pollAccidentSummary(){
          try{
            const res=await fetch('/api/radiation_status/summary',{cache:'no-store'});
            if(!res.ok) return;
            const arr=await res.json();
            if(!Array.isArray(arr)) return;
            const accidents=arr.filter(x=>x && x.status==='accident');
            for(const it of accidents){
              const code=it.genName;
              const display=codeToDisplay[code]||code;
              const shortName=codeToShort[code]||code;
              const {isConfirmed}=await Swal.fire({
                icon:'warning',
                title:`ğŸš¨ ${display}`,
                html:`
                  <p>ë°©ì‚¬ì„  ìˆ˜ì¹˜ê°€ <strong>ê¸°ì¤€(${it.threshold} ÂµSv/h)</strong>ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.</p>
                  <p><strong>í˜„ì¬ê°’:</strong> ${it.current_value} ÂµSv/h</p>
                  ${it.average ? `<p><small>í‘œë³¸ í‰ê· : ${it.average} ÂµSv/h</small></p>`:''}
                  <p>êµ¬í˜¸ì†Œ ëŒ€í”¼ ì í•©ë„ í‰ê°€ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                `,
                showCancelButton:true,
                confirmButtonText:'ì´ë™',
                cancelButtonText:'ë‹«ê¸°',
                confirmButtonColor:'#d33',
                cancelButtonColor:'#aaa',
                allowOutsideClick:false
              });
              if(isConfirmed){
                const url=`/optimal_shelter_result/${encodeURIComponent(shortName)}`;
                console.log('[Popup] navigate ->', url);
                window.location.assign(url);
                break;
              }
            }
          }catch(e){
            console.error('summary poll failed', e);
          }
        }
        window.addEventListener('load', ()=>{
          pollAccidentSummary();
          setInterval(pollAccidentSummary, 15*60*1000);
        });
      </script>
</body>
</html>