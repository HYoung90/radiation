<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방사선 비상 대응 의사결정 지원 시스템</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 기본 PC 및 태블릿 스타일 */
        body {
            background-color: #f3f4f6;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: row;
            min-height: 100vh;
            padding-right: 20px;
            margin-left: 250px; /* 사이드바 길이만큼 왼쪽 여백 추가 */
        }

        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            flex-grow: 1;
        }

        .sidebar {
            width: 250px;
            background-color: #343a40;
            padding-top: 20px;
            color: white;
            font-size: 18px;
            text-align: center;
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.1);
            z-index: 1001; /* 챗봇보다 위에 위치 */
        }

        .sidebar img {
            width: 200px;
            margin-bottom: 30px;
            cursor: pointer;
        }

        .sidebar a {
            color: white;
            padding: 15px;
            text-decoration: none;
            display: block;
            transition: 0.3s;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .sidebar a:hover {
            background-color: #575757;
            transform: translateX(5px);
        }

        .container {
            margin-top: 20px;
            flex-grow: 1;
            padding-left: 20px;
            margin-right: 20px;
            width: 100%;
        }

        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #f5f5f5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .header-logo img {
            height: 180px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .header-logo img:hover {
            transform: scale(1.05);
        }

        .title-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .title-container h1 {
            font-size: 36px;
            margin: 0;
            color: #000000;
            text-align: center;
            width: 100%;
        }

        .refresh-icon {
            font-size: 15px;
            color: #333;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .grid-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            text-align: left;
            font-family: Arial, sans-serif;
        }

        .grid-item h5 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #333;
        }

        .grid-item p {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }

        .grid-item p strong {
            color: #333;
        }

        /* 반응형 스타일 - 모바일 화면 (화면 너비 768px 이하) */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* 세로 방향으로 변경 */
                margin-left: 0;         /* 사이드바 왼쪽 여백 제거 */
                padding-right: 0;
            }

            .sidebar {
                width: 100%;            /* 사이드바 너비를 100%로 변경 */
                height: auto;           /* 높이 자동 조절 */
                position: relative;     /* 스크롤 가능하도록 상대 위치로 변경 */
                box-shadow: none;       /* 그림자 제거 */
            }

            .sidebar img {
                width: 150px;           /* 이미지 크기 축소 */
                margin-top: 20px;       /* 상단 여백 추가 */
            }

            .container {
                padding: 10px;          /* 여백을 10px로 줄이기 */
                margin: 0;              /* 마진 제거 */
            }

            .header-container {
                margin-bottom: 10px;    /* 하단 여백 축소 */
            }

            .title-container h1 {
                font-size: 24px;        /* 제목 크기 축소 */
            }

            .refresh-icon {
                font-size: 12px;        /* 시간 크기 축소 */
                margin-top: 5px;        /* 상단 여백 축소 */
                justify-content: center; /* 가운데 정렬 */
            }

            #map {
                height: 300px;          /* 지도의 높이 축소 */
                margin-bottom: 20px;    /* 하단 여백 축소 */
            }

            .grid-container {
                grid-template-columns: 1fr; /* 그리드를 1열로 변경 */
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="방사선 데이터" onclick="location.reload()">
        <a href="/radiation_summary">주간 방사선량 데이터</a>
        <a href="/nuclear_radiation">원자력 발전소 주변 방사선량 데이터</a>
        <a href="/busan_radiation">부산 환경방사선량 데이터</a>
        <a href="{{ url_for('accident_select') }}">원자력 발전소 사고 판단</a>
        <a href="{{ url_for('optimal_shelter_evaluation') }}">구호소 대피 적합도 평가</a>
        <a href="/spectrum">방사성 핵종 스펙트럼 분석</a>
        <a href="/analysis1">토양 방사능 데이터</a>
        <a href="/analysis2">대기 중 방사능 데이터</a>
        <a href="/analysis4">수중 방사능 데이터</a>
    </div>

    <div class="container mt-5">
        <div class="header-container">
            <div class="title-container">
                <h1 id="title">방사선 비상 대응 의사결정 지원 시스템</h1>
            </div>
            <div class="refresh-icon">
                <span id="currentTime"></span>
            </div>
        </div>

        <div id="map"></div>

        <div class="weather-container">
            <h2 class="mb-4">최근 기상 데이터</h2>
            <div class="grid-container" id="weatherGridContainer">
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        function updateCurrentTime() {
            var now = new Date();
            var formattedDateTime = now.toLocaleString();
            document.getElementById('currentTime').textContent = formattedDateTime;
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        var map = L.map('map').setView([36.5, 127.5], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> | &copy; OpenStreetMap contributors',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        var regions = {
            "KR": [35.3213, 129.2941, "고리 원자력발전소"],
            "WS": [35.7131, 129.4775, "월성 원자력발전소"],
            "YK": [35.4165, 126.4178, "한빛 원자력발전소"],
            "UJ": [37.0941, 129.3819, "한울 원자력발전소"],
            "SU": [35.3376, 129.3115, "새울 원자력발전소"],
        };

        for (var genName in regions) {
            var marker = L.marker([regions[genName][0], regions[genName][1]]).addTo(map)
                .bindPopup('<div class="custom-popup-title"><a href="/' + genName + '" style="text-decoration:none;color:black;">' + regions[genName][2] + '</a></div>');

            marker.on('click', function() {
                this.openPopup();
            });
        }

        function loadLatestWeatherData() {
            const weatherGridContainer = document.getElementById("weatherGridContainer");
            weatherGridContainer.innerHTML = "";
            const plantNames = {
                "KR": "고리 원자력발전소",
                "WS": "월성 원자력발전소",
                "YK": "한빛 원자력발전소",
                "UJ": "한울 원자력발전소",
                "SU": "새울 원자력발전소"
            };

            for (let genName in plantNames) {
                fetch(`/api/data/${genName}/latest`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Received latest data for genName ${genName}:`, data);
                        if (data.time) {
                            const gridItem = document.createElement("div");
                            gridItem.className = "grid-item";
                            gridItem.innerHTML = `
                                <h5>${plantNames[genName]}</h5>
                                <p><strong>측정 시간:</strong> ${data.time || '정보 없음'}</p>
                                <p><strong>기온:</strong> ${data.temperature || '정보 없음'}°C</p>
                                <p><strong>습도:</strong> ${data.humidity || '정보 없음'}%</p>
                                <p><strong>강수량:</strong> ${data.rainfall !== undefined && data.rainfall !== null ? data.rainfall : '0 '}mm</p>
                                <p><strong>풍속:</strong> ${data.windspeed !== undefined && data.windspeed !== null ? data.windspeed : '0 '}m/s</p>
                                <p><strong>풍향:</strong> ${data.winddirection || '정보 없음'}°</p>
                                <p><strong>안정도:</strong> ${data.stability || '정보 없음'}</p>
                            `;
                            weatherGridContainer.appendChild(gridItem);
                        } else {
                            console.error(`Unexpected data format for genName ${genName}:`, data);
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching latest weather data for genName ${genName}:`, error);
                    });
            }
        }

        loadLatestWeatherData();
    </script>
    <div id="chat-icon" style="position: fixed; bottom: 24px; right: 24px; z-index: 1000; cursor: pointer;">
      <img src="{{ url_for('static', filename='images/chat_icon.png') }}" alt="Chat" width="60" height="60">
    </div>
    <div id="chat-box" style="display:none; position:fixed; bottom:100px; right:24px; width:300px; height:400px; background:white; border:1px solid #ccc; border-radius:10px; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.15); overflow:hidden; font-family: sans-serif;">
      <header style="background:#007bff; color:white; padding:10px; font-weight:bold;">비상 대응 챗봇</header>
      <div id="chat-messages" style="padding:10px; height:300px; overflow-y:auto; font-size:14px;"></div>
      <div style="display:flex; border-top:1px solid #ccc;">
        <input id="user-input" type="text" placeholder="질문을 입력하세요..." style="flex:1; padding:8px; border:none;">
        <button onclick="sendMessage()" style="background:#007bff; color:white; border:none; padding:8px 12px;">전송</button>
      </div>
    </div>
    <script>
      const chatIcon = document.getElementById("chat-icon");
      const chatBox = document.getElementById("chat-box");
      const chatMessages = document.getElementById("chat-messages");
      chatIcon.onclick = () => {
        chatBox.style.display = (chatBox.style.display === "none") ? "block" : "none";
      };
      function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message) return;
        chatMessages.innerHTML += `<div><strong>👤 사용자:</strong> ${message}</div>`;
        input.value = "";
        fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        })
        .then(res => res.json())
        .then(data => {
          const answer = data.answer || "답변을 찾을 수 없습니다.";
          chatMessages.innerHTML += `<div><strong>🤖 챗봇:</strong> ${answer}</div>`;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(() => {
          chatMessages.innerHTML += `<div><strong>🤖 챗봇:</strong> 오류가 발생했습니다.</div>`;
        });
      }
    </script>
     <script>
        const codeToDisplay={
          "KR":"고리 원자력발전소",
          "WS":"월성 원자력발전소",
          "YK":"한빛 원자력발전소",
          "UJ":"한울 원자력발전소",
          "SU":"새울 원자력발전소"
        };
        const codeToShort={
          "KR":"고리","WS":"월성","YK":"한빛","UJ":"한울","SU":"새울"
        };
        async function pollAccidentSummary(){
          try{
            const res=await fetch('/api/radiation_status/summary',{cache:'no-store'});
            if(!res.ok) return;
            const arr=await res.json();
            if(!Array.isArray(arr)) return;
            const accidents=arr.filter(x=>x && x.status==='accident');
            for(const it of accidents){
              const code=it.genName;
              const display=codeToDisplay[code]||code;
              const shortName=codeToShort[code]||code;
              const {isConfirmed}=await Swal.fire({
                icon:'warning',
                title:`🚨 ${display}`,
                html:`
                  <p>방사선 수치가 <strong>기준(${it.threshold} µSv/h)</strong>을 초과했습니다.</p>
                  <p><strong>현재값:</strong> ${it.current_value} µSv/h</p>
                  ${it.average ? `<p><small>표본 평균: ${it.average} µSv/h</small></p>`:''}
                  <p>구호소 대피 적합도 평가 결과 페이지로 이동하시겠습니까?</p>
                `,
                showCancelButton:true,
                confirmButtonText:'이동',
                cancelButtonText:'닫기',
                confirmButtonColor:'#d33',
                cancelButtonColor:'#aaa',
                allowOutsideClick:false
              });
              if(isConfirmed){
                const url=`/optimal_shelter_result/${encodeURIComponent(shortName)}`;
                console.log('[Popup] navigate ->', url);
                window.location.assign(url);
                break;
              }
            }
          }catch(e){
            console.error('summary poll failed', e);
          }
        }
        window.addEventListener('load', ()=>{
          pollAccidentSummary();
          setInterval(pollAccidentSummary, 15*60*1000);
        });
      </script>
</body>
</html>