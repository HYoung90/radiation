<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ genName }}의 방사선 데이터</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
  <style>
    /* ─── 공통 스타일 ───────────────────────────────────────── */
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f7f6;
      margin: 0; padding: 20px; color: #333;
    }
    .container {
      max-width: 1200px; margin: 20px auto;
      background: #fff; padding: 30px;
      border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    h1, h3 {
      color: #2c3e50; margin-bottom: 20px; text-align: center;
    }
    h1 { font-size: 2.2em; }
    h3 { font-size: 1.5em; margin-top: 30px; text-align: left; }
    .btn-back {
      display: inline-block; padding: 12px 25px;
      font-size: 1em; background: #6c757d; color: #fff;
      border: none; border-radius: 8px; text-decoration: none;
      cursor: pointer; margin-bottom: 25px;
      transition: .3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-back:hover {
      background: #5a6268; transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .image-container { text-align: center; margin: 30px 0; }
    .image-container img {
      max-width: 40%; border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #measurementPoints {
      display: flex; flex-wrap: wrap; gap: 10px;
      margin-bottom: 30px; justify-content: flex-start;
    }
    .measurement-btn {
      padding: 12px 20px; font-size: .95em;
      background: #007bff; color: #fff; border: none;
      border-radius: 8px; cursor: pointer;
      transition: .3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .measurement-btn:hover { background: #0056b3; transform: translateY(-2px); }
    .measurement-btn.selected {
      background: #28a745; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    /* DataTables 스타일 */
    #radiationHistoryTable {
      width: 100% !important; border-collapse: collapse;
      margin-top: 20px; font-size: 1em;
    }
    #radiationHistoryTable thead th {
      background: #e9ecef; color: #495057;
      padding: 12px 15px; text-align: center;
      border-bottom: 2px solid #dee2e6; font-weight: bold;
    }
    #radiationHistoryTable tbody td {
      padding: 10px 15px; text-align: center;
      border-bottom: 1px solid #e9ecef;
    }
    #radiationHistoryTable tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    #radiationHistoryTable tbody tr:hover {
      background: #e2f4f8; cursor: pointer;
    }
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_length {
      display: none;
    }
    #viewBackupData {
      display: block; margin: 30px auto; padding: 15px 30px;
      font-size: 1.1em; background: #e0a800; color: #fff;
      border: none; border-radius: 8px; cursor: pointer;
      transition: .3s; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #viewBackupData:hover {
      background: #d39e00; transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="javascript:history.back()" class="btn-back">← 뒤로가기</a>

    <div class="image-container">
      <img src="{{ url_for('static', filename='images/' + genName + '.png') }}"
           alt="{{ genName }} 발전소 이미지">
    </div>

    <h3>측정 지점 리스트</h3>
    <div id="measurementPoints"></div>

    <h3>선택된 측정 지점의 데이터</h3>
    <table id="radiationHistoryTable" class="display">
      <thead>
        <tr>
          <th>측정 시간</th>
          <th>방사선량 (μSv/h)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="viewBackupData" onclick="viewBackupData()">
      과거 데이터 보기
    </button>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
  <script>
    // 시간 문자열 포맷 함수: "YYYY-MM-DD hh:mm:ss" → "YYYY-MM-DD hh:mm:ss"
    function formatDateTime(dtString) {
      if (!dtString) return '정보 없음';
      // T와 Z를 붙여서 UTC로 파싱
      const utc = dtString.replace(' ', 'T') + 'Z';
      const d = new Date(utc);
      const pad = n => String(n).padStart(2, '0');
      const Y = d.getFullYear(),
            M = pad(d.getMonth()+1),
            D = pad(d.getDate()),
            h = pad(d.getHours()),
            m = pad(d.getMinutes()),
            s = pad(d.getSeconds());
      return `${Y}-${M}-${D} ${h}:${m}:${s}`;
    }

    $(document).ready(function() {
      const genName = "{{ genName }}";
      const table = $('#radiationHistoryTable').DataTable({
        paging: false, info: false, searching: false, lengthChange: false,
        order: [[0, 'desc']]
      });

      // 과거 데이터 보기
      window.viewBackupData = function() {
        const expl = $('#measurementPoints .measurement-btn.selected').data('expl');
        if (!expl) return alert('측정 지점을 선택해주세요.');
        location.href = `/nuclear_radiation_detail/{{ genName }}/${encodeURIComponent(expl)}`;
      };

      // 측정 지점 로드
      function loadMeasurementPoints() {
        $.getJSON(`/api/nuclear_radiation/points?genName=${genName}`)
          .done(data => {
            data.sort((a,b) => {
              const na=+a.match(/MS-(\d+)/)[1],
                    nb=+b.match(/MS-(\d+)/)[1];
              return na-nb;
            });
            $('#measurementPoints').empty();
            data.forEach(pt => {
              $('#measurementPoints').append(
                `<button class="measurement-btn" data-expl="${pt}">${pt}</button>`
              );
            });
            if (data.length) {
              $('.measurement-btn').first().addClass('selected');
              loadRadiationHistory(data[0]);
            }
            $('.measurement-btn').click(function(){
              $('.measurement-btn').removeClass('selected');
              $(this).addClass('selected');
              loadRadiationHistory($(this).data('expl'));
            });
          })
          .fail(() => console.error('측정 지점 로드 실패'));
      }

      // 히스토리 로드
      function loadRadiationHistory(expl) {
        $.getJSON(
          `/api/nuclear_radiation/history?genName=${genName}&expl=${encodeURIComponent(expl)}`
        ).done(data => {
          table.clear();
          data.forEach(item => {
            table.row.add([
              formatDateTime(item.time),
              `${parseFloat(item.value).toFixed(3)} μSv/h`
            ]);
          });
          table.draw();
        }).fail(() => console.error('히스토리 로드 실패'));
      }

      // 초기 실행
      loadMeasurementPoints();
    });
  </script>
</body>
</html>
